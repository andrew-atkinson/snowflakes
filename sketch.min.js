let font,textArr,loopSpeed,allWordsRestart,allWordsDisplayed,currentWidth,previousWidth,currentHeight,previousHeight,flakes=[],fr=0,frameRateCalc=!1,frameRateFactor=1,numFlakes=300,dropIndexCounter=0,dropFreq=20,loopPos=1,pauseDuration=90,dropSpeed=.4,sampleScale=.2,lines=[],evalFrames=5;function preload(){font=loadFont("fonts/Pacifico-Regular.ttf")}function setup(){createCanvas(windowWidth,windowHeight),currentWidth=width,previousWidth=width,currentHeight=height,previousHeight=height,makeWords(),flakes=makeFlakes(floor(numFlakes*frameRateFactor))}function draw(){background(15,15,25),stroke(255),strokeWeight(1),frameCount>30&&lines&&(allWordsDisplayed=!0,allWordsRestart=!0,lines.forEach((t=>{t.newSetUp||(allWordsRestart=!1),t.wordsDisplayedPause||(allWordsDisplayed=!1)})),lines.forEach((t=>{t.update()})),allWordsRestart&&(allWordsRestart=!1,loopPos=0,makeWords()));for(let t=0;t<flakes.length;t++)flakes[t].update(),flakes[t].draw();frameCount<=evalFrames?fr+=frameRate():frameRateCalc||(frameRateFactor=min(fr/evalFrames/30,1),frameRateCalc=!0,numFlakes*=frameRateFactor,frameRateFactor<1&&(makeWords(),flakes=makeFlakes(floor(numFlakes*frameRateFactor))))}function windowResized(t){onWindowResizeOrDeviceTurn()}function deviceTurned(t){onWindowResizeOrDeviceTurn()}function onWindowResizeOrDeviceTurn(){resizeCanvas(windowWidth,windowHeight),flakesOnWindowResize(previousWidth,windowWidth,previousHeight,windowHeight),makeWords(),previousWidth=width,previousHeight=height}function makeWords(){lines=[],sampleScale=map(width,1e3,500,.2,.5,!0),noStroke();let t=getURLParams(),e=0;t.to&&e++,t.message&&e++,t.from&&e++;let s=height/e,i=0,r=0;if(t.to){let e=new Words(t.to,i+.66*s,loopPos,s,r,pauseDuration);lines.push(e),i+=s}if(t.message){r+=60;let e=new Words(t.message,i+.66*s,loopPos,s,r,pauseDuration);lines.push(e),i+=s}if(t.from){r+=60;let e=new Words(t.from,i+.66*s,loopPos,s,r,pauseDuration);lines.push(e)}let o=lines.reduce(((t,e)=>e.textArr.length>t?e.textArr.length:t),1);loopSpeed=floor(o/200)}class Flake{constructor(){this.x=random(width),this.y=random(height),this.a=random(PI),this.spin=3*random(-.02,.02),this.size=random(Math.sqrt(width*height/2e3),Math.sqrt(width*height/500)),this.pointsArr=[]}createPoints(){let t=[];for(let e=0;e<this.size;e+=random(width/500,width/150))t.push({x:e,s:random(0,1+Math.sqrt(width/300)),c:color(random(200,255),random(200,255),255,120)});return t}update(){this.y>height&&(this.y=random(-50,-10)),this.y+=this.size/30}draw(){push(),translate(this.x,this.y),rotate(this.a+this.spin);for(let t=0;t<6;t++){for(let t=0;t<this.pointsArr.length;t++)this.pointsArr[t].c.setAlpha(random(this.pointsArr[t].s,65*this.pointsArr[t].s)),stroke(this.pointsArr[t].c),strokeWeight(this.pointsArr[t].s),point(this.pointsArr[t].x,0);rotate(PI/3)}pop(),this.a+=this.spin}}function makeFlakes(t){let e=[];for(let s=0;s<t;s++){let t=new Flake;t.pointsArr=t.createPoints(),e.push(t)}return e}function flakesOnWindowResize(t,e,s,i){let r=e/t,o=i/s;for(let t in flakes){let e=flakes[t].x*r,s=flakes[t].y*o;flakes[t].x=e,flakes[t].y=s}}class Words{constructor(t,e,s,i,r,o){this.message=decodeURIComponent(t),this.y=e,this.textArr=[],this.wordsSize=1,this.offset=0,this.maxHeight=i,this.loopPos=s,this.newSetUp=!1,this.startdelay=r,this.pauseDuration=o,this.wordsDisplayedPause=!1,this.dropIndexCounter=0,this.setUpWords()}setUpWords(){for(textAlign(CENTER,CENTER),textSize(this.wordsSize);textWidth(this.message)+.2*width<=width&&(textSize(this.wordsSize++),!(this.wordsSize>=this.maxHeight)););this.offset=width-textWidth(this.message),this.textArr=font.textToPoints(this.message,this.offset/2,this.y,this.wordsSize,{sampleFactor:sampleScale*frameRateFactor}),this.textArr.forEach((t=>{t.dropIndex=floor(random(this.textArr.length)),t.speed=1}))}drawPoints(t){for(let e=0;e<t;e++)strokeWeight(random(3e-4*width,.003*width)),point(this.textArr[e].x,this.textArr[e].y)}fallPoints(t){let e=!0;this.textArr.forEach((s=>{s.y<height+100&&(e=!1),t>s.dropIndex&&(s.speed+=dropSpeed,s.y+=s.speed)})),this.drawPoints(this.textArr.length),e&&(this.newSetUp=!0)}update(){this.startdelay>0?this.loopPos=1:this.loopPos+=loopSpeed,this.startdelay<=0&&this.drawPoints(min(this.loopPos,this.textArr.length)),this.loopPos>=this.textArr.length&&(this.wordsDisplayedPause=!0),this.startdelay<=0&&this.loopPos>=this.textArr.length&&!this.newSetUp&&allWordsDisplayed&&(this.fallPoints(this.dropIndexCounter),this.dropIndexCounter+=dropFreq),this.startdelay--}}